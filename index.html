<html>
<head>
	<title>openEtG</title>
	<style>
		body {
			background-color: black;
			color: white;
			margin:0;
		}
	</style>
	<script src="/socket.io/socket.io.js"></script>
	<script src="js.js"></script>
</head>
<body>
	<script>
"use strict"
var Cards, Targeting, targetingMode, targetingModeCb, targetingText, game, discarding;
loadcards(function(cards, targeting) {
	Cards = cards;
	Targeting = targeting;
	console.log("Cards loaded");
});
function getTarget(src, active, cb){
	var targetingFilter = Targeting[active.activename];
	if (targetingFilter){
		targetingMode = function(t){ return (t == game.player2 || t.owner == game.player1 || t.passive == "cloak" || !game.player2.isCloaked()) && targetingFilter(src, t); }
		targetingModeCb = cb;
		for(var key in TargetFilters){
			if (TargetFilters[key] == targetingFilter){
				targetingText = "Target "+key;
				break;
			}
		}
	}else{
		cb();
	}
}
function maybeSetText(obj, text){
	if (obj.text != text)obj.setText(text);
}
function maybeSetTexture(obj, text){
	if (text){
		obj.visible = true;
		obj.setTexture(text);
	}else obj.visible = false;
}
function reflectPos(obj){
	var pos = obj instanceof PIXI.Point?obj:obj.position;
	pos.x=900-pos.x;
	pos.y=600-pos.y;
}
function centerAnchor(obj){
	obj.anchor.x=obj.anchor.y=.5;
}
function setWinner(play){
	game.winner=play;
	endturn.setText(play==game.player1?"Won":"Lost");
}
function tgtToBits(x){
	if (x == undefined){
		return 0;
	}else if (x == game.player1){
		return 1;
	}else if (x == game.player2){
		return 9;
	}else if (x == game.player1.weapon){
		return 17;
	}else if (x == game.player2.weapon){
		return 25;
	}else if (x == game.player1.shield){
		return 33;
	}else if (x == game.player2.shield){
		return 41;
	}else{
		return (x instanceof Creature?2:4)+(x.owner==game.player1?0:1)|x.getIndex()<<3;
	}
}
function bitsToTgt(x){
	var tgtop=x&7;
	if (tgtop == 0){
		return undefined;
	}else if (tgtop==1){
		return [game.player2, game.player1, game.player2.weapon, game.player1.weapon, game.player2.shield, game.player1.shield][x>>3];
	}else if (tgtop==2){
		return game.player2.creatures[x>>3];
	}else if (tgtop==3){
		return game.player1.creatures[x>>3];
	}else if (tgtop==4){
		return game.player2.permanents[x>>3];
	}else if (tgtop==5){
		return game.player1.permanents[x>>3];
	}else console.log("Unknown tgtop: "+tgtop+", "+x);
}
function creaturePos(j, i){
	var p = new PIXI.Point(160+i*24, 310+(i%5)*30);
	if (j){
		reflectPos(p);
	}
	return p;
}
function permanentPos(j, i){
	var p = new PIXI.Point(160+i*26, 490+(i%3)*30);
	if (j){
		reflectPos(p);
	}
	return p;
}
var renderer = PIXI.autoDetectRenderer(900, 600);
document.body.appendChild(renderer.view);
var loader = new PIXI.AssetLoader(["esheet.png"]);
loader.onComplete = function(){
	var baseTexture = PIXI.Texture.fromImage("esheet.png");
	var icons = [];
	for(var i=0; i<13; i++){
		icons.push(new PIXI.Texture(baseTexture, new PIXI.Rectangle(i*32, 0, 32, 32)));
	}
	eicons = icons;
}
loader.load();
var menuui = new PIXI.Stage(0x336699, true), editorui, gameui = new PIXI.Stage(0x336699, true);
var mainStage = menuui;

var nopic = PIXI.Texture.fromImage("null.png"), eicons, caimgcache = {}, crimgcache = {}, primgcache = {};
var elecols = [0xa99683,0xaa5999,0x777777,0x996633,0x5f4930,0x50a005,0xcc6611,0x205080,0xa9a9a9,0x337ddd,0xccaa22,0x333333,0x77bbdd];
function lighten(c){
	return (c&255)/2+127|((c>>8)&255)/2+127<<8|((c>>16)&255)/2+127<<16;
}
function getIcon(ele){
	return eicons?eicons[ele]:nopic;
}
function getCardImage(code){
	if (caimgcache[code])return caimgcache[code];
	else{
		var card = Cards[code];
		var rend = new PIXI.RenderTexture(120, 20);
		var graphics = new PIXI.Graphics();
		graphics.lineStyle(2, 0x222222, 1);
		graphics.beginFill(card?(card.upped?lighten(elecols[card.element]):elecols[card.element]):elecols[0]);
		graphics.drawRect(0, 0, 120, 20);
		graphics.endFill();
		if (card){
			var text = new PIXI.Text(card.name, {font: "11px Arial bold", fill:card.upped?"black":"white"});
			text.position.x = 2;
			text.position.y = 5;
			graphics.addChild(text);
			if (card.cost){
				text = new PIXI.Text(card.cost, {font: "11px Arial bold", fill:card.upped?"black":"white"});
				text.anchor.x = 1;
				text.position.x = 100;
				text.position.y = 5;
				graphics.addChild(text);
				if (card.costele){
					var eleicon = new PIXI.Sprite(getIcon(card.costele));
					eleicon.position.x = 119;
					eleicon.position.y = 10;
					eleicon.anchor.x = 1;
					eleicon.anchor.y = .5;
					eleicon.scale.x = .5;
					eleicon.scale.y = .5;
					graphics.addChild(eleicon);
				}
			}
		}
		rend.render(graphics);
		return eicons?(caimgcache[code] = rend):rend;
	}
}
function getCreatureImage(code){
	if (crimgcache[code])return crimgcache[code];
	else{
		var card = Cards[code];
		var rend = new PIXI.RenderTexture(120, 30);
		var graphics = new PIXI.Graphics();
		graphics.lineStyle(2, 0x222222, 1);
		graphics.beginFill(card?(card.upped?lighten(elecols[card.element]):elecols[card.element]):elecols[0]);
		graphics.drawRect(0, 0, 120, 30);
		graphics.endFill();
		if (card){
			var text = new PIXI.Text(Cards[code].name, {font: "12px Arial bold", fill:card.upped?"black":"white"});
			text.position.x = 2;
			text.position.y = 5;
			graphics.addChild(text);
		}
		rend.render(graphics);
		return crimgcache[code] = rend;
	}
}
function getPermanentImage(code){
	if (primgcache[code])return primgcache[code];
	else{
		var card = Cards[code];
		var rend = new PIXI.RenderTexture(80, 30);
		var graphics = new PIXI.Graphics();
		graphics.lineStyle(2, 0x222222, 1);
		graphics.beginFill(card?(card.upped?lighten(elecols[card.element]):elecols[card.element]):elecols[0]);
		graphics.drawRect(0, 0, 80, 30);
		graphics.endFill();
		if (card){
			var text = new PIXI.Text(Cards[code].name, {font: "12px Arial bold", fill:card.upped?"black":"white"});
			text.position.x = 2;
			text.position.y = 5;
			graphics.addChild(text);
		}
		rend.render(graphics);
		return primgcache[code] = rend;
	}
}
function initGame(data, ai){
	if(data.seed != undefined){
		rng.seed(data.seed);
	}
	game = mkGame(data.first);
	var idx, code, decks = [data.urdeck, data.deck];
	for(var j=0; j<2; j++){
		for(var i=0; i<decks[j].length; i++){
			if (Cards[code=decks[j][i]]){
				game.players[j].deck.push(Cards[code]);
			}else if (~(idx=TrueMarks.indexOf(code))){
				game.players[j].mark=idx;
			}
		}
	}
	if (game.turn == game.player1){
		game.player1.drawhand();
		game.player2.drawhand();
	}else{
		game.player2.drawhand();
		game.player1.drawhand();
	}
	if (ai){
		game.player2.ai = ai;
		if(game.turn == game.player2){
			game.player2.ai();
		}
	}
	endturn.setText("End Turn");
	mainStage = gameui;
}
function getDeck(){
	var deckimport = document.getElementById("deckimport").value;
	return deckimport?deckimport.split(" "):['4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4ve', '4ve', '4ve', '6tt', '6tt', '6tt', '6tt', '4vf', '4vf', '4vf', '4vf', '4vf', '8pj'];
}
var bpvp = new PIXI.Text("Search", {font: "16px Arial bold"});
var brandai = new PIXI.Text("Dumb AI", {font: "16px Arial bold"});
var beditor = new PIXI.Text("Editor", {font: "16px Arial bold"});
bpvp.position.x = 200;
bpvp.position.y = 200;
brandai.position.x = 200;
brandai.position.y = 250;
beditor.position.x = 200;
beditor.position.y = 300;
bpvp.interactive = true;
brandai.interactive = true;
beditor.interactive = true;
bpvp.click = function() {
	if (Cards){
		socket.emit("pvpwant", {deck: getDeck(), room: document.getElementById("roomname").value});
	}
}
brandai.click = function() {
	if (Cards){
		rng.seed(Math.random()*4000000000);
		var e0 = Math.ceil(rng.real()*12), e1=Math.ceil(rng.real()*12);
		var deck = [Cards.QuantumPillar, Cards.QuantumPillar, Cards.QuantumPillar, Cards.QuantumPillar];
		var pillar = Cards[(5000+e0*100).toString(32)];
		for(var i=0; i<20; i++){
			deck.push(pillar);
		}
		for(var i=0; i<30; i++){
			deck.push(randomcard(rng.real()<.3, function(x){return x.element == e0;}));
		}
		for(var i=0; i<10; i++){
			deck.push(randomcard(rng.real()<.3, function(x){return x.element == e1;}));
		}
		for(var i=0; i<deck.length; i++){
			deck[i] = deck[i].code;
		}
		deck.push(TrueMarks[e1]);
		initGame({ first:rng.real()<.5, deck:deck, urdeck:getDeck() },
			function(){
				for(var i=this.hand.length-1; i>=0; i--){
					if (this.hand[i].type == PillarEnum){
						this.summon(i);
					}
				}
				for(var i=this.hand.length-1; i>=0; i--){
					if ((this.hand[i].type == CreatureEnum || this.hand[i].type == PermanentEnum) && this.cansummon(i)){
						this.summon(i);
					}
				}
				this.endturn(this.hand.length==8?0:null);
			}
		);
	}
}
var editordeck, editorelement = 0, editordecksprites, editorcolumns, editoreleicons;
beditor.click = function() {
	if (Cards){
		editorui = new PIXI.Stage(0x336699, true);
		var bsave = new PIXI.Text("Done", {font: "16px Arial bold"});
		bsave.position.x = 8;
		bsave.position.y = 8;
		bsave.click = function(){
			document.getElementById("deckimport").value = editordeck.join(" ");
			mainStage = menuui;
			editorui = undefined;
		}
		bsave.interactive = true;
		editorui.addChild(bsave);
		var bclear = new PIXI.Text("Clear", {font: "16px Arial bold"});
		bclear.position.x = 8;
		bclear.position.y = 28;
		bclear.click = function(){
			editordeck.length = 0;
		}
		bclear.interactive = true;
		editorui.addChild(bclear);
		editorcolumns = [];
		editordecksprites = [];
		editordeck = getDeck();
		editoreleicons = [];
		for(var i=0; i<13; i++){
			var sprite = new PIXI.Sprite(nopic);
			sprite.position.x = 8;
			sprite.position.y = 150 + i*32;
			(function(_i){
				sprite.click = function() { editorelement = _i; }
			})(i);
			sprite.interactive = true;
			editoreleicons.push(sprite);
			editorui.addChild(sprite);
		}
		for(var i=0; i<60; i++){
			var sprite = new PIXI.Sprite(nopic);
			sprite.position.x = 100+Math.floor(i/10)*120;
			sprite.position.y = 50+(i%10)*20;
			(function(_i){
				sprite.click = function() {
					editordeck.splice(_i, 1);
				}
			})(i);
			sprite.interactive = true;
			editorui.addChild(sprite);
			editordecksprites.push(sprite);
		}
		for(var i=0; i<6; i++){
			editorcolumns.push([[],[]]);
			for(var j=0; j<15; j++){
				var sprite = new PIXI.Sprite(nopic);
				sprite.position.x = 100+i*120;
				sprite.position.y = 300+j*20;
				(function(_i, _j){
					sprite.click = function() {
						if(editordeck.length<60){
							editordeck.push(editorcolumns[_i][1][editorelement][_j]);
						}
					}
				})(i, j);
				sprite.interactive = true;
				editorui.addChild(sprite);
				editorcolumns[i][0].push(sprite);
			}
			// TODO Rewrite to go through cards without filtercards; filter with one pass
			for(var j=0; j<13; j++){
				editorcolumns[i][1].push(filtercards(i>2, function(x){ return x.element == j && (((i==0 || i==3) && x.type == CreatureEnum)||((i==1 || i==4) && x.type <= PermanentEnum)||((i==2 || i==5) && x.type == SpellEnum)); }));
			}
		}
		mainStage = editorui;
	}
}
menuui.addChild(bpvp);
menuui.addChild(brandai);
menuui.addChild(beditor);
//gameui
var cloakgfx = new PIXI.Graphics();
cloakgfx.beginFill(0);
cloakgfx.drawRect(300, 20, 490, 220);
cloakgfx.endFill();
gameui.addChild(cloakgfx);
var endturn = new PIXI.Text("", {font: "16px Arial bold"});
endturn.position.x = 800;
endturn.position.y = 540;
endturn.interactive = true;
endturn.click = function(e, discard) {
	if (game.winner){
		for (var i=0; i<foeplays.length; i++){
			gameui.removeChild(foeplays[i][1]);
		}
		foeplays.length = 0;
		game = undefined;
		mainStage = menuui;
	}else if (game.turn == game.player1){
		if (discard == undefined && game.player1.hand.length == 8){
			discarding = true;
		}else{
			discarding = false;
			if(!game.player2.ai){
				socket.emit("endturn", discard);
			}
			game.player1.endturn(discard);
			targetingMode = undefined;
			for (var i=0; i<foeplays.length; i++){
				gameui.removeChild(foeplays[i][1]);
			}
			foeplays.length = 0;
			if(game.player2.ai){
				game.player2.ai();
			}
		}
	}
}
gameui.addChild(endturn);
var cancel = new PIXI.Text("Cancel", {font: "16px Arial bold"});
cancel.position.x = 800;
cancel.position.y = 500;
cancel.interactive = true;
cancel.click = function() {
	if (game.turn == game.player1){
		if (targetingMode){
			targetingMode = null;
			targetingModeCb = null;
		}else if (discarding){
			discarding = false;
		}
	}
}
var turntell = new PIXI.Text("", {font: "16px Arial bold"});
turntell.position.x = 800;
turntell.position.y = 570;
gameui.addChild(turntell);
gameui.addChild(cancel);
var foeplays = [];
var infotext = new PIXI.Text("", {font: "16px Arial bold"});
infotext.position.x=100;
infotext.position.y=585;
gameui.addChild(infotext);
function setInfo(obj){
	if(obj){
		maybeSetText(infotext, obj.info());
	}
}
var handsprite = [new Array(8), new Array(8)];
for (var i=0; i<8; i++){
	handsprite[0][i] = new PIXI.Sprite(nopic);
	handsprite[0][i].position.x=760;
	handsprite[0][i].position.y=300+20*i;
	handsprite[0][i].interactive = true;
	(function(_i){
		handsprite[0][i].mouseover = function(){
			setInfo(game.player1.hand[_i]);
		}
		handsprite[0][i].click = function(){
			if (discarding){
				endturn.click(null, _i);
				return;
			}
			if (game.turn != game.player1 || game.player1.silence)return;
			var card = game.player1.hand[_i];
			if (card && (card.cost == 0 || game.player1.canspend(card.costele, card.cost))){
				if (card.type != SpellEnum){
					console.log("summoning " + _i);
					socket.emit("summon", _i);
					game.player1.summon(_i);
				}else{
					getTarget(game.player1, card.active, function(tgt) {
						socket.emit("summon", _i|tgtToBits(tgt)<<3);
						game.player1.summon(_i, tgt);
					});
				}
			}
		}
	})(i);
	gameui.addChild(handsprite[0][i]);
}
for (var i=0; i<8; i++){
	handsprite[1][i] = new PIXI.Sprite(nopic);
	handsprite[1][i].position.x=20;
	handsprite[1][i].position.y=40+20*i;
	gameui.addChild(handsprite[1][i]);
}
var creasprite = [new Array(23), new Array(23)];
var permsprite = [new Array(16), new Array(16)];
var weapsprite = [new PIXI.Sprite(nopic), new PIXI.Sprite(nopic)];
var shiesprite = [new PIXI.Sprite(nopic), new PIXI.Sprite(nopic)];
var marksprite = [new PIXI.Sprite(nopic), new PIXI.Sprite(nopic)];
var quantatext = [new PIXI.DisplayObjectContainer(), new PIXI.DisplayObjectContainer()];
var hptext = [new PIXI.Text("", {font: "18px Arial bold"}), new PIXI.Text("", {font: "18px Arial bold"})];
var poisontext = [new PIXI.Text("", {font: "16px Arial bold"}), new PIXI.Text("", {font: "16px Arial bold"})];
var decktext = [new PIXI.Text("", {font: "16px Arial bold"}), new PIXI.Text("", {font: "16px Arial bold"})];
for (var j=0; j<2; j++){
	(function(_j){
		for (var i=0; i<23; i++){
			creasprite[j][i] = new PIXI.Sprite(nopic);
			var creatext = new PIXI.Text("", {font: "12px Arial bold"});
			creatext.position.x = 58;
			creatext.anchor.x = 1;
			creasprite[j][i].addChild(creatext);
			centerAnchor(creasprite[j][i]);
			creasprite[j][i].position = creaturePos(j, i);
			creasprite[j][i].interactive = true;
			(function(_i){
				creasprite[j][i].mouseover = function(){
					setInfo(game.players[_j].creatures[_i]);
				}
				creasprite[j][i].click = function(){
					var crea = game.players[_j].creatures[_i];
					if (!crea)return;
					if (targetingMode && targetingMode(crea)){
						targetingMode = undefined;
						targetingModeCb(crea);
					}else if (_j == 0 && !targetingMode && crea.canactive()){
						getTarget(crea, crea.active.cast, function(tgt){
							targetingMode = undefined;
							socket.emit("active", tgtToBits(crea)|tgtToBits(tgt)<<8);
							crea.useactive(tgt);
						});
					}
				}
			})(i);
			gameui.addChild(creasprite[j][i]);
		}
		for (var i=0; i<16; i++){
			permsprite[j][i] = new PIXI.Sprite(nopic);
			var permtext = new PIXI.Text("", {font: "12px Arial bold"});
			permtext.position.x = 38;
			permtext.anchor.x = 1;
			permsprite[j][i].addChild(permtext);
			centerAnchor(permsprite[j][i]);
			permsprite[j][i].position = permanentPos(j, i);
			permsprite[j][i].interactive = true;
			(function(_i){
				permsprite[j][i].mouseover = function(){
					setInfo(game.players[_j].permanents[_i]);
				}
				permsprite[j][i].click = function(){
					var perm = game.players[_j].permanents[_i];
					if (!perm)return;
					if (targetingMode && targetingMode(perm)){
						targetingMode = undefined;
						targetingModeCb(perm);
					}else if (_j == 0 && !targetingMode && perm.canactive()){
						getTarget(perm, perm.active.cast, function(tgt){
							targetingMode = undefined;
							socket.emit("active", tgtToBits(perm)|tgtToBits(tgt)<<8);
							perm.useactive(tgt);
						});
					}
				}
			})(i);
			gameui.addChild(permsprite[j][i]);
		}
		centerAnchor(weapsprite[j]);
		centerAnchor(shiesprite[j]);
		centerAnchor(marksprite[j]);
		weapsprite[j].position.x=690;
		weapsprite[j].position.y=530;
		weapsprite[j].interactive = true;
		shiesprite[j].position.x=690;
		shiesprite[j].position.y=560;
		shiesprite[j].interactive = true;
		marksprite[j].position.x = 690;
		marksprite[j].position.y = 500;
		var weaptext = new PIXI.Text("", {font: "12pt Arial bold"});
		weaptext.position.x = 58;
		weaptext.anchor.x = 1;
		weapsprite[j].addChild(weaptext);
		var shietext = new PIXI.Text("", {font: "12pt Arial bold"});
		shietext.position.x = 58;
		shietext.anchor.x = 1;
		shiesprite[j].addChild(shietext);
		weapsprite[j].mouseover = function(){
			setInfo(game.players[_j].weapon);
		}
		shiesprite[j].mouseover = function(){
			setInfo(game.players[_j].shield);
		}
		weapsprite[j].click = function(){
			var weap = game.players[_j].weapon;
			if (!weap)return
			if (targetingMode && targetingMode(weap)){
				targetingMode = undefined;
				targetingModeCb(weap);
			}else if (_j == 0 && !targetingMode && weap.canactive()){
				getTarget(weap, weap.active.cast, function(tgt){
					targetingMode = undefined;
					socket.emit("active", tgtToBits(weap)|tgtToBits(tgt)<<8);
					weap.useactive(tgt);
				});
			}
		}
		shiesprite[j].click = function(){
			if (!game.players[_j].shield)return
			if (targetingMode && targetingMode(game.players[_j].shield)){
				targetingMode = undefined;
				targetingModeCb(game.players[_j].shield);
			}
		}
		if (j){
			reflectPos(weapsprite[j]);
			reflectPos(shiesprite[j]);
			reflectPos(marksprite[j]);
		}
		gameui.addChild(weapsprite[j]);
		gameui.addChild(shiesprite[j]);
		gameui.addChild(marksprite[j]);
		centerAnchor(hptext[j]);
		centerAnchor(poisontext[j]);
		centerAnchor(decktext[j]);
		quantatext[j].position.x=j?792:0;
		quantatext[j].position.y=j?100:308;
		hptext[j].position.x=50;
		hptext[j].position.y=560;
		poisontext[j].position.x=50;
		poisontext[j].position.y=580;
		decktext[j].position.x=50;
		decktext[j].position.y=540;
		if (j){
			reflectPos(hptext[j]);
			reflectPos(poisontext[j]);
			reflectPos(decktext[j]);
		}
		var child;
		for(var k=1; k<13; k++){
			quantatext[j].addChild(child=new PIXI.Text("", {font: "16px Arial bold"}));
			child.position.x = (k&1)?32:86;
			child.position.y = Math.floor((k-1)/2)*32+8;
		}
		for(var k=1; k<13; k++){
			quantatext[j].addChild(child=new PIXI.Sprite(nopic));
			child.position.x = (k&1)?0:54;
			child.position.y = Math.floor((k-1)/2)*32;
		}
		hptext[j].interactive = true;
		hptext[j].mouseover = function(){
			setInfo(game.players[_j]);
		}
		hptext[j].click = function(){
			if (targetingMode && targetingMode(game.players[_j])){
				targetingMode = undefined;
				targetingModeCb(game.players[_j]);
			}
		}
	})(j);
	gameui.addChild(quantatext[j]);
	gameui.addChild(hptext[j]);
	gameui.addChild(poisontext[j]);
	gameui.addChild(decktext[j]);
}
var fgfx = new PIXI.Graphics();
gameui.addChild(fgfx);
var socket = io.connect("http://"+location.hostname+':13602');
socket.on("pvpgive", initGame);
socket.on("endturn", function(data) {
	game.player2.endturn(data);
});
socket.on("summon", function(bits) {
	console.log("summon call: " + bits);
	var handindex = bits&7;
	var sprite = new PIXI.Sprite(nopic);
	sprite.position.x=foeplays.length*40;
	sprite.position.y=8;
	gameui.addChild(sprite);
	foeplays.push([game.player2.hand[handindex], sprite]);
	game.player2.summon(handindex, bitsToTgt(bits>>3));
});
socket.on("active", function(bits) {
	var c=bitsToTgt(bits&255), t=bitsToTgt((bits>>8)&255);
	console.log("active call: " + bits);
	c.useactive(t);
});
socket.on("foeleft", function(data) {
	setWinner(game.player1);
});
socket.on("chat", function(data) {
	document.getElementById("chatArea").value = data;
});
function maybeSendChat(e){
	e.cancelBubble = true;
	if (e.keyCode != 13)return;
	var chat=document.getElementById("chatinput");
	if (chat.value){
		socket.emit("chat", chat.value);
		chat.value = "";
	}
}
function animate() {
	setTimeout(requestAnimate, 40);
	if (mainStage == gameui){
		maybeSetText(turntell, discarding?"Discard":targetingMode?targetingText:game.turn == game.player1?"Your Turn":"Their Turn");
		for(var i=0; i<foeplays.length; i++){
			maybeSetTexture(foeplays[i][1], getPermanentImage(foeplays[i][0].code));
		}
		cloakgfx.visible = game.player2.isCloaked();
		fgfx.clear();
		if (game.turn == game.player1 && !game.player1.silence){
			for(var i=0; i<game.player1.hand.length; i++){
				var card = game.player1.hand[i];
				if (game.player1.canspend(card.costele, card.cost)){
					fgfx.beginFill(elecols[card.costele]);
					fgfx.drawRect(handsprite[0][i].position.x+120, handsprite[0][i].position.y, 20, 20);
					fgfx.endFill();
				}
			}
		}
		fgfx.beginFill(0, 0);
		fgfx.lineStyle(2, 0xffffff);
		var j=game.turn == game.player1?0:1;
		for(var i=0; i<23; i++){
			var cr=game.players[j].creatures[i];
			if (cr && cr.canactive()){
				fgfx.drawRect(creasprite[j][i].position.x-60, creasprite[j][i].position.y-15, 120, 30);
			}
		}
		for(var i=0; i<16; i++){
			var pr=game.players[j].permanents[i];
			if (pr && !(pr instanceof Pillar) && pr.active.cast && !pr.usedactive){
				fgfx.drawRect(permsprite[j][i].position.x-40, permsprite[j][i].position.y-15, 80, 30);
			}
		}
		var wp = game.players[j].weapon, sh = game.players[j].shield;
		if (wp && wp.active.cast && !wp.usedactive){
			fgfx.drawRect(weapsprite[j].position.x-60, weapsprite[j].position.y-15, 120, 30);
		}
		fgfx.lineStyle(0, 0, 0);
		fgfx.endFill();
		for(var j=0; j<2; j++){
			if (game.players[j].sosa){
				fgfx.beginFill(elecols[Death], .5);
				fgfx.drawRect(hptext[j].position.x-30, hptext[j].position.y-10, 60, 20);
				fgfx.endFill();
			}
			if (game.players[j].silence){
				fgfx.beginFill(elecols[Aether], .3);
				fgfx.drawRect(handsprite[j][0].position.x-2, handsprite[j][0].position.y-2, 124, 164);
				fgfx.endFill();
			}else if (game.players[j].sanctuary){
				fgfx.beginFill(elecols[Light], .3);
				fgfx.drawRect(handsprite[j][0].position.x-2, handsprite[j][0].position.y-2, 124, 164);
				fgfx.endFill();
			}
			for(var i=0;i<8;i++){
				maybeSetTexture(handsprite[j][i], game.players[j].hand[i]?getCardImage(j==0||game.player1.precognition?game.players[j].hand[i].code:"000"):null);
			}
			for(var i=0; i<23; i++){
				var cr = game.players[j].creatures[i];
				if (cr && !(j == 1 && cloakgfx.visible)){
					creasprite[j][i].setTexture(getCreatureImage(cr.card.code));
					creasprite[j][i].alpha = cr.immaterial?.7:1;
					creasprite[j][i].visible = true;
					var child = creasprite[j][i].getChildAt(0);
					child.visible = true; // PIXI bug: children visibility corrupted by parent
					maybeSetText(child, cr.activetext() + cr.trueatk()+"|"+cr.truehp());
					var pos = creasprite[j][i].position;
					if (cr == game.players[j].gpull){
						fgfx.beginFill(0xffaa00, .3);
						fgfx.drawRect(pos.x-62, pos.y-17, 124, 34);
						fgfx.endFill();
					}
					if (cr.frozen){
						fgfx.beginFill(0x0000ff, .3);
						fgfx.drawRect(pos.x-62, pos.y-17, 124, 34);
						fgfx.endFill();
					}
					if (cr.delayed){
						fgfx.beginFill(0xffff00, .3);
						fgfx.drawRect(pos.x-62, pos.y-17, 124, 34);
						fgfx.endFill();
					}
					fgfx.lineStyle(1, 0);
					if (cr.airborne){
						fgfx.beginFill(elecols[Air], .8);
						fgfx.drawRect(pos.x-62, pos.y+5, 12, 12);
						fgfx.endFill();
					}
					if (cr.adrenaline){
						fgfx.beginFill(elecols[Life], .8);
						fgfx.drawRect(pos.x-54, pos.y+5, 12, 12);
						fgfx.endFill();
					}
					if (cr.momentum){
						fgfx.beginFill(elecols[Gravity], .8);
						fgfx.drawRect(pos.x-46, pos.y+5, 12, 12);
						fgfx.endFill();
					}
					if (cr.psion){
						fgfx.beginFill(elecols[Aether], .8);
						fgfx.drawRect(pos.x-38, pos.y+5, 12, 12);
						fgfx.endFill();
					}
					if (cr.burrowed){
						fgfx.beginFill(elecols[Earth], .8);
						fgfx.drawRect(pos.x-30, pos.y+5, 12, 12);
						fgfx.endFill();
					}
					if (cr.poison){
						fgfx.beginFill(cr.aflatoxin?elecols[Darkness]:elecols[Death], .8);
						fgfx.drawRect(pos.x-22, pos.y+5, 12, 12);
						fgfx.endFill();
					}
					fgfx.lineStyle(0, 0, 0);
				}else creasprite[j][i].visible = false;
			}
			for(var i=0; i<16; i++){
				var pr = game.players[j].permanents[i];
				if (pr && !(j == 1 && cloakgfx.visible && pr.passive != "cloak")){
					permsprite[j][i].setTexture(getPermanentImage(pr.card.code));
					permsprite[j][i].alpha = pr.immaterial?.7:1;
					permsprite[j][i].visible = true;
					var child = permsprite[j][i].getChildAt(0);
					child.visible = true; // PIXI bug: children visibility corrupted by parent
					if (pr instanceof Pillar){
						maybeSetText(child, (pr.active == Actives.pend?(pr.pendstate?pr.owner.mark:pr.card.element)+" ":"") + "x"+pr.charges);
					}else maybeSetText(child, pr.activetext() + (pr.charges?" "+pr.charges:""));
				}else permsprite[j][i].visible = false;
			}
			var wp = game.players[j].weapon;
			if (wp && !(j == 1 && cloakgfx.visible)){
				var child = weapsprite[j].getChildAt(0);
				maybeSetText(child, wp.activetext() + " " + wp.trueatk());
				weapsprite[j].alpha = wp.immaterial?.7:1;
				child.visible = true;
				weapsprite[j].setTexture(getCreatureImage(wp.card.code));
				weapsprite[j].visible =  true;
			}else weapsprite[j].visible = false;
			var sh = game.players[j].shield;
			if (sh && !(j == 1 && cloakgfx.visible)){
				var child = shiesprite[j].getChildAt(0);
				var dr=sh.truedr();
				maybeSetText(child, (sh.active.shield?activename(sh.active.shield):"") + (sh.charges? " x"+sh.charges:"") + (dr?" "+dr+"DR":""));
				shiesprite[j].alpha = sh.immaterial?.7:1;
				child.visible = true;
				shiesprite[j].setTexture(getCreatureImage(sh.card.code));
				shiesprite[j].visible = true;
			}else shiesprite[j].visible = false;
			marksprite[j].setTexture(getIcon(game.players[j].mark));
			if (game.players[j].weapon && (game.players[j].weapon.frozen || game.players[j].weapon.delayed)){
				var pos = weapsprite[j].position;
				if (cr.frozen){
					fgfx.beginFill(0x0000ff, .3);
					fgfx.drawRect(pos.x-42, pos.y-12, 84, 24);
					fgfx.endFill();
				}
				if (cr.delayed){
					fgfx.beginFill(0xffff00, .3);
					fgfx.drawRect(pos.x-42, pos.y-12, 84, 24);
					fgfx.endFill();
				}
			}
			for(var i=1; i<13; i++){
				maybeSetText(quantatext[j].getChildAt(i-1), game.players[j].quanta[i].toString());
			}
			for(var i=1; i<13; i++){
				quantatext[j].getChildAt(i+12-1).setTexture(getIcon(i));
			}
			maybeSetText(hptext[j], game.players[j].hp + "/" + game.players[j].maxhp);
			maybeSetText(poisontext[j], game.players[j].poison + (game.players[j].neuro?"psn!":"psn"));
			maybeSetText(decktext[j], game.players[j].deck.length + "cards");
		}
	}else if(mainStage == editorui){
		for (var i=0; i<13; i++){
			editoreleicons[i].setTexture(getIcon(i));
		}
		for (var i=0; i<editordeck.length; i++){
			editordecksprites[i].visible = true;
			editordecksprites[i].setTexture(getCardImage(editordeck[i]));
		}
		for (;i<60; i++){
			editordecksprites[i].visible = false;
		}
		for (var i=0; i<6; i++){
			for(var j=0; j<editorcolumns[i][1][editorelement].length; j++){
				editorcolumns[i][0][j].visible = true;
				editorcolumns[i][0][j].setTexture(getCardImage(editorcolumns[i][1][editorelement][j]));
			}
			for(;j<15; j++){
				editorcolumns[i][0][j].visible = false;
			}
		}
	}
	for(var i=anims.length-1; i>=0; i--){
		anims[i].next();
	}
	renderer.render(mainStage);
}
function requestAnimate(){ requestAnimFrame(animate); }
requestAnimate();
document.addEventListener("keydown", function(e){
	if (e.keyCode == 32){
		endturn.click();
	}
});
	</script>
	<br/>
	<input id="deckimport" type="text" placeholder="Deck" />
	<input id="roomname" type="text" placeholder="Room" />
	<br/><input id="chatArea" type="text" style="width:100%;" readonly />
	<br/><input id="chatinput" type="text" placeholder="Chat" style="width:100%" onkeydown="maybeSendChat(event)" />
</body>
</html>