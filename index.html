<html>
<head>
	<title>openEtG</title>
	<style>
		body {
			background-color: black;
			color: white;
			margin:0;
		}
	</style>
	<script src="/socket.io/socket.io.js"></script>
	<script src="js.js" type="text/javascript;version=1.7"></script>
</head>
<body>
	<script type="text/javascript;version=1.7">
var Cards, Targeting, targetingMode, targetingModeCb, targetingText, myturn, player1, player2, players, winner, discarding;
loadcards(function(cards, targeting) {
	Cards = cards;
	Targeting = targeting;
	console.log("Cards loaded");
});
function getTarget(src, active, cb){
	if (active in Targeting){
		let targetingFilter = Targeting[active];
		targetingMode = function(t){ return (t == player2 || t.owner == player1 || !cloakgfx.visible) && targetingFilter(src, t); }
		targetingModeCb = cb;
		for(var key in TargetFilters){
			if (TargetFilters[key] == targetingFilter){
				targetingText = "Target "+key;
				break;
			}
		}
	}else{
		cb();
	}
}
function maybeSetText(obj, text){
	if (obj.text != text)obj.setText(text);
}
function maybeSetTexture(obj, text){
	if (text){
		obj.visible = true;
		obj.setTexture(text);
	}else obj.visible = false;
}
function reflectPos(obj){
	obj.position.x=900-obj.position.x;
	obj.position.y=600-obj.position.y;
}
function centerAnchor(obj){
	obj.anchor.x=obj.anchor.y=.5;
}
function setWinner(play){
	winner=play;
	endturn.setText(play==player1?"Won":"Lost");
}
function tgtToBits(x){
	if (x == undefined){
		return 0;
	}else if (x == player1){
		return 1;
	}else if (x == player2){
		return 9;
	}else if (x == player1.weapon){
		return 17;
	}else if (x == player2.weapon){
		return 25;
	}else if (x == player1.shield){
		return 33;
	}else if (x == player2.shield){
		return 41;
	}else{
		return (x instanceof Creature?2:4)+(x.owner==player1?0:1)|x.getIndex()<<3;
	}
}
function bitsToTgt(x){
	var tgtop=x&7;
	if (tgtop == 0){
		return undefined;
	}else if (tgtop==1){
		return [player2, player1, player2.weapon, player1.weapon, player2.shield, player1.shield][x>>3];
	}else if (tgtop==2){
		return player2.creatures[x>>3];
	}else if (tgtop==3){
		return player1.creatures[x>>3];
	}else if (tgtop==4){
		return player2.permanents[x>>3];
	}else if (tgtop==5){
		return player1.permanents[x>>3];
	}else console.log("Unknown tgtop: "+tgtop+", "+x);
}
var renderer = PIXI.autoDetectRenderer(900, 600);
document.body.appendChild(renderer.view);
var menuui = new PIXI.Stage(0x336699, true), gameui = new PIXI.Stage(0x336699, true);
var mainStage = menuui;

var nopic = PIXI.Texture.fromImage("null.png"), cimgcache = {};
var elecols = [0xccbbaa,0xaa7799,0x888888,0xaa7766,0x504030,0x50a005,0xfcba05,0x205080,0xbbbbbb,0x3377dd,0xeeaa66,0x333333,0x99ccee];
function lighten(c){
	return (c&255)/2+127|((c>>8)&255)/2+127<<8|((c>>16)&255)/2+127<<16;
}
function getCardImage(code){
	if (cimgcache[code])return cimgcache[code];
	else{
		var card = Cards[code];
		var rend = new PIXI.RenderTexture(80, 20);
		var graphics = new PIXI.Graphics();
		graphics.lineStyle(2, 0x222222, 1);
		graphics.beginFill(card?(card.upped?lighten(elecols[card.element]):elecols[card.element]):elecols[0]);
		graphics.drawRect(0, 0, 80, 20);
		graphics.endFill();
		if (card){
			var text = new PIXI.Text(Cards[code].name, {font: "12px Arial bold", fill:card.upped?"black":"white"});
			text.position.x = 2;
			text.position.y = 5;
			graphics.addChild(text);
		}
		rend.render(graphics);
		return cimgcache[code] = rend;
	}
}
var deck = ['4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4vc', '4ve', '4ve', '4ve', '6tt', '6tt', '6tt', '6tt', '4vf', '4vf', '4vf', '4vf', '4vf', '8pj'];
var bpvp = new PIXI.Text("Search", {font: "16px Arial bold"});
bpvp.position.x = 200;
bpvp.position.y = 200;
bpvp.interactive = true;
bpvp.click = function() {
	if (Cards != null){
		var deckimport = document.getElementById("deckimport").value;
		if (deckimport)deck = deckimport.split(" ");
		var roomname = document.getElementById("roomname").value || undefined;
		socket.emit("pvpwant", {deck: deck, room: roomname});
	}
}
menuui.addChild(bpvp);
var endturn = new PIXI.Text("", {font: "16px Arial bold"});
endturn.position.x = 800;
endturn.position.y = 540;
endturn.interactive = true;
endturn.click = function() {
	if (winner){
		myturn = false;
		for (var i=0; i<foeplays.length; i++){
			gameui.removeChild(foeplays[i][1]);
		}
		foeplays = [];
		mainStage = menuui;
	}else if (myturn){
		if (player1.hand.length == 8){
			discarding=true;
		}else{
			socket.emit("endturn");
			player1.endturn();
			targetingMode = undefined;
			myturn = false;
			for (var i=0; i<foeplays.length; i++){
				gameui.removeChild(foeplays[i][1]);
			}
			foeplays = [];
		}
	}
}
gameui.addChild(endturn);
var cancel = new PIXI.Text("Cancel", {font: "16px Arial bold"});
cancel.position.x = 800;
cancel.position.y = 500;
cancel.interactive = true;
cancel.click = function() {
	if (myturn){
		if (targetingMode){
			targetingMode = null;
			targetingModeCb = null;
		}else if (discarding){
			discarding = false;
		}
	}
}
var turntell = new PIXI.Text("", {font: "16px Arial bold"});
turntell.position.x = 800;
turntell.position.y = 570;
gameui.addChild(turntell);
gameui.addChild(cancel);
var foeplays = [];
var infotext = new PIXI.Text("", {font: "16px Arial bold"});
infotext.position.x=100;
infotext.position.y=585;
gameui.addChild(infotext);
function setInfo(obj){
	if(obj){
		maybeSetText(infotext, obj.info());
	}
}
var handsprite = [new Array(8), new Array(8)];
for (var i=0; i<8; i++){
	handsprite[0][i] = new PIXI.Sprite(nopic);
	handsprite[0][i].position.x=800;
	handsprite[0][i].position.y=300+20*i;
	handsprite[0][i].interactive = true;
	let _i=i;
	handsprite[0][i].mouseover = function(){
		setInfo(player1.hand[_i]);
	}
	handsprite[0][i].click = function(){
		if (discarding){
			socket.emit("endturn", _i);
			player1.discard(_i);
			player1.endturn();
			myturn=false;
			discarding = false;
			return;
		}
		if (!myturn || player1.silence)return;
		var card = player1.hand[_i];
		if (card && (card.cost == 0 || player1.canspend(card.costele, card.cost))){
			if (card.type != SpellEnum){
				console.log("summoning " + _i);
				socket.emit("summon", _i);
				player1.summon(_i);
			}else{
				getTarget(player1, card.active, function(tgt) {
					socket.emit("summon", _i|tgtToBits(tgt)<<3);
					player1.summon(_i, tgt);
				});
			}
		}
	}
	gameui.addChild(handsprite[0][i]);
}
for (var i=0; i<8; i++){
	handsprite[1][i] = new PIXI.Sprite(nopic);
	handsprite[1][i].position.x=20;
	handsprite[1][i].position.y=40+20*i;
	gameui.addChild(handsprite[1][i]);
}
var creasprite = [new Array(23), new Array(23)];
var permsprite = [new Array(16), new Array(16)];
var weapsprite = [new PIXI.Sprite(nopic), new PIXI.Sprite(nopic)];
var shiesprite = [new PIXI.Sprite(nopic), new PIXI.Sprite(nopic)];
var marksprite = [new PIXI.Sprite(nopic), new PIXI.Sprite(nopic)];
var quantatext = [new PIXI.Text("", {font: "16px Arial bold"}), new PIXI.Text("", {font: "16px Arial bold"})];
var hptext = [new PIXI.Text("", {font: "18px Arial bold"}), new PIXI.Text("", {font: "18px Arial bold"})];
var poisontext = [new PIXI.Text("", {font: "16px Arial bold"}), new PIXI.Text("", {font: "16px Arial bold"})];
var decktext = [new PIXI.Text("", {font: "16px Arial bold"}), new PIXI.Text("", {font: "16px Arial bold"})];
for (var j=0; j<2; j++){
	let _j=j;
	for (var i=0; i<23; i++){
		creasprite[j][i] = new PIXI.Sprite(nopic);
		centerAnchor(creasprite[j][i]);
		creasprite[j][i].position.x=160+i*16;
		creasprite[j][i].position.y=360+(i%5)*20;
		if (j){
			reflectPos(creasprite[j][i]);
		}
		creasprite[j][i].interactive = true;
		let _i=i;
		creasprite[j][i].mouseover = function(){
			setInfo(players[_j].creatures[_i]);
		}
		creasprite[j][i].click = function(){
			var crea = players[_j].creatures[_i];
			if (!crea)return;
			if (targetingMode && targetingMode(crea)){
				targetingMode = undefined;
				targetingModeCb(crea);
			}else if (_j == 0 && !targetingMode && crea.canactive()){
				getTarget(crea, crea.active, function(tgt){
					targetingMode = undefined;
					socket.emit("active", tgtToBits(crea)|tgtToBits(tgt)<<8);
					crea.useactive(tgt);
				});
			}
		}
		gameui.addChild(creasprite[j][i]);
	}
	for (var i=0; i<16; i++){
		permsprite[j][i] = new PIXI.Sprite(nopic);
		centerAnchor(permsprite[j][i]);
		permsprite[j][i].position.x=160+i*16;
		permsprite[j][i].position.y=490+(i%5)*20;
		if (j){
			reflectPos(permsprite[j][i]);
		}
		permsprite[j][i].interactive = true;
		let _i=i;
		permsprite[j][i].mouseover = function(){
			setInfo(players[_j].permanents[_i]);
		}
		permsprite[j][i].click = function(){
			let perm = players[_j].permanents[_i];
			if (!perm)return;
			if (targetingMode && targetingMode(perm)){
				targetingMode = undefined;
				targetingModeCb(perm);
			}else if (_j == 0 && !targetingMode && perm.canactive()){
				getTarget(perm, perm.active, function(tgt){
					targetingMode = undefined;
					socket.emit("active", tgtToBits(perm)|tgtToBits(tgt)<<8);
					perm.useactive(tgt);
				});
			}
		}
		gameui.addChild(permsprite[j][i]);
	}
	centerAnchor(weapsprite[j]);
	centerAnchor(shiesprite[j]);
	centerAnchor(marksprite[j]);
	weapsprite[j].position.x=550;
	weapsprite[j].position.y=500;
	weapsprite[j].interactive = true;
	shiesprite[j].position.x=550;
	shiesprite[j].position.y=530;
	shiesprite[j].interactive = true;
	marksprite[j].position.x = 550;
	marksprite[j].position.y = 470;
	weapsprite[j].mouseover = function(){
		setInfo(players[_j].weapon);
	}
	shiesprite[j].mouseover = function(){
		setInfo(players[_j].shield);
	}
	weapsprite[j].click = function(){
		var weap = players[_j].weapon;
		if (!weap)return
		if (targetingMode && targetingMode(weap)){
			targetingMode = undefined;
			targetingModeCb(weap);
		}else if (_j == 0 && !targetingMode && weap.canactive()){
			getTarget(weap, weap.active, function(tgt){
				targetingMode = undefined;
				socket.emit("active", tgtToBits(weap)|tgtToBits(tgt)<<8);
				weap.useactive(tgt);
			});
		}
	}
	shiesprite[j].click = function(){
		if (!players[_j].shield)return
		if (targetingMode && targetingMode(players[_j].shield)){
			targetingMode = undefined;
			targetingModeCb(players[_j].shield);
		}
	}
	if (j){
		reflectPos(weapsprite[j]);
		reflectPos(shiesprite[j]);
		reflectPos(marksprite[j]);
	}
	gameui.addChild(weapsprite[j]);
	gameui.addChild(shiesprite[j]);
	gameui.addChild(marksprite[j]);
	centerAnchor(quantatext[j]);
	centerAnchor(hptext[j]);
	centerAnchor(poisontext[j]);
	centerAnchor(decktext[j]);
	quantatext[j].position.x=50;
	quantatext[j].position.y=400;
	hptext[j].position.x=50;
	hptext[j].position.y=550;
	poisontext[j].position.x=50;
	poisontext[j].position.y=570;
	decktext[j].position.x=50;
	decktext[j].position.y=530;
	if (j){
		reflectPos(quantatext[j]);
		reflectPos(hptext[j]);
		reflectPos(poisontext[j]);
		reflectPos(decktext[j]);
	}
	hptext[j].interactive = true;
	hptext[j].mouseover = function(){
		setInfo(players[_j]);
	}
	hptext[j].click = function(){
		if (targetingMode && targetingMode(players[_j])){
			targetingMode = undefined;
			targetingModeCb(players[_j]);
		}
	}
	gameui.addChild(quantatext[j]);
	gameui.addChild(hptext[j]);
	gameui.addChild(poisontext[j]);
	gameui.addChild(decktext[j]);
}
var fgfx = new PIXI.Graphics();
gameui.addChild(fgfx);
var cloakgfx = new PIXI.Graphics();
cloakgfx.beginFill(0);
cloakgfx.drawRect(300, 20, 490, 220);
cloakgfx.endFill();
gameui.addChild(cloakgfx);
var socket = io.connect("http://"+location.hostname+':13602');
socket.on("pvpgive", function(data) {
	rng.seed(data.seed);
	myturn = data.first;
	player1 = new Player();
	player2 = new Player();
	player1.foe = player2;
	player2.foe = player1;
	players = [player1, player2];
	var idx, code, decks = [deck, data.deck];
	for(var j=0; j<2; j++){
		for(var i=0; i<decks[j].length; i++){
			if (Cards[code=decks[j][i]]){
				players[j].deck.push(Cards[code]);
			}else if (~(idx=TrueMarks.indexOf(code))){
				players[j].mark=idx;
			}
		}
	}
	if (myturn){
		player1.drawhand();
		player2.drawhand();
	}else{
		player2.drawhand();
		player1.drawhand();
	}
	winner = undefined;
	endturn.setText("End Turn");
	mainStage = gameui;
});
socket.on("endturn", function(data) {
	if (data){
		player2.discard(data);
	}
	player2.endturn();
	myturn = true;
});
socket.on("summon", function(bits) {
	console.log("summon call: " + bits);
	var handindex = bits&7;
	var sprite = new PIXI.Sprite(nopic);
	sprite.position.x=foeplays.length*40;
	sprite.position.y=8;
	gameui.addChild(sprite);
	foeplays.push([player2.hand[handindex], sprite]);
	player2.summon(handindex, bitsToTgt(bits>>3));
});
socket.on("active", function(bits) {
	var c=bitsToTgt(bits&255), t=bitsToTgt((bits>>8)&255);
	console.log("active call: " + bits);
	c.useactive(t);
});
socket.on("foeleft", function(data) {
	setWinner(player1);
});
socket.on("chat", function(data) {
	document.getElementById("chatArea").value = data;
});
function maybeSendChat(e){
	e.cancelBubble = true;
	if (e.keyCode != 13)return;
	var chat=document.getElementById("chatinput");
	if (chat.value){
		socket.emit("chat", chat.value);
		chat.value = "";
	}
}
function animate() {
	if (mainStage == gameui){
		maybeSetText(turntell, discarding?"Discard":targetingMode?targetingText:myturn?"Your Turn":"Their Turn");
		for(var i=0; i<foeplays.length; i++){
			maybeSetTexture(foeplays[i][1], getCardImage(foeplays[i][0].code));
		}
		cloakgfx.visible = false;
		for(var i=0; i<16; i++){
			if (player2.permanents[i] && player2.permanents[i].passive == "cloak"){
				cloakgfx.visible = true;
				break;
			}
		}
		if (myturn){
			fgfx.visible = true;
			fgfx.clear();
			for(var i=0; i<player1.hand.length; i++){
				var card = player1.hand[i];
				if (player1.canspend(card.costele, card.cost)){
					fgfx.beginFill(elecols[card.element]);
					fgfx.drawRect(handsprite[0][i].position.x+80, handsprite[0][i].position.y, 20, 20);
					fgfx.endFill();
				}
			}
		}else fgfx.visible = false;
		for(var j=0; j<2; j++){
			for(var i=0;i<8;i++){
				maybeSetTexture(handsprite[j][i], players[j].hand[i]?getCardImage(j==0||player1.precognition?players[j].hand[i].code:"000"):null);
			}
			for(var i=0;i<23;i++){
				maybeSetTexture(creasprite[j][i], players[j].creatures[i]?getCardImage(players[j].creatures[i].card.code):null);
			}
			for(var i=0;i<16;i++){
				maybeSetTexture(permsprite[j][i], players[j].permanents[i]?getCardImage(players[j].permanents[i].card.code):null);
			}
			maybeSetTexture(weapsprite[j], players[j].weapon?getCardImage(players[j].weapon.card.code):null);
			maybeSetTexture(shiesprite[j], players[j].shield?getCardImage(players[j].shield.card.code):null);
			marksprite[j].setTexture(getCardImage((5010+players[j].mark).toString(32)));
			var qtext = "";
			for(var i=1; i<7; i++){
				qtext += players[j].quanta[i] + "\t" + players[j].quanta[i+6] + "\n";
			}
			maybeSetText(quantatext[j], qtext);
			maybeSetText(hptext[j], players[j].hp + "/" + players[j].maxhp);
			maybeSetText(poisontext[j], players[j].poison + (players[j].neuro?"psn!":"psn"));
			maybeSetText(decktext[j], players[j].deck.length + "cards");
		}
	}
	renderer.render(mainStage);
	requestAnimFrame(animate);
}
requestAnimFrame(animate);
document.addEventListener("keydown", function(e){
	if (e.keyCode == 32){
		endturn.click();
	}
});
	</script>
	<br/>
	<input id="deckimport" type="text" placeholder="Deck" />
	<input id="roomname" type="text" placeholder="Room" />
	Firefox only for now
	<br/><input id="chatArea" type="text" style="width:100%;" readonly />
	<br/><input id="chatinput" type="text" placeholder="Chat" style="width:100%" onkeydown="maybeSendChat(event)" />
</body>
</html>